# 🎓 Guardian 课堂集成使用指南

**功能**: 学生上课切换到其他网站时，自动发送信息给课堂系统

---

## ✅ 已实现的功能

### 1. 实时上报学生访问行为
- ✅ 访问的URL
- ✅ 访问时间
- ✅ 学生姓名
- ✅ 是否被拦截

### 2. 实时警报
- ✅ 学生访问违规网站 → 立即通知教师
- ✅ 学生关闭保护 → 立即警报
- ✅ 学生禁用插件 → 立即警报

### 3. 数据统计
- ✅ 课堂期间访问统计
- ✅ 每个学生的违规次数
- ✅ 最常访问的违规网站

---

## 🚀 快速使用（3步骤）

### 步骤1：启用课堂模式

**在学生加入课堂时，运行这个代码（浏览器控制台）：**

```javascript
chrome.runtime.sendMessage('pdpjidcjmkolcdaiolapcomjnbhgjekf', {
  action: 'enableClassroomMode',
  data: {
    sessionId: 123,                    // 课堂ID
    serverUrl: 'http://localhost:8086', // MetaSeekOJ服务器
    allowedDomains: [
      'metaseekoj.com',
      'localhost',
      'baidu.com'
    ]
  }
}, (response) => {
  console.log(response.message); // "课堂模式已启用"
});
```

### 步骤2：绑定学生信息

```javascript
chrome.runtime.sendMessage('pdpjidcjmkolcdaiolapcomjnbhgjekf', {
  action: 'bindUser',
  data: {
    userId: 'S001',
    username: '张三'
  }
});
```

### 步骤3：测试

- 学生访问 www.bilibili.com
- Guardian 拦截并发送数据到：
  ```
  POST http://localhost:8086/api/classroom/guardian-alert/
  ```

---

## 📡 上报的数据格式

### 实时警报（学生访问违规网站）

```json
{
  "type": "blocked_access",
  "session_id": 123,
  "student_id": "S001",
  "student_name": "张三",
  "domain": "bilibili.com",
  "url": "https://www.bilibili.com",
  "timestamp": 1698739200000,
  "message": "学生 张三 尝试访问被拦截的网站: bilibili.com"
}
```

**发送到**: `POST /api/classroom/guardian-alert/`

### 批量访问记录（每5秒上报）

```json
{
  "reports": [
    {
      "session_id": 123,
      "student_id": "S001",
      "student_name": "张三",
      "url": "https://www.baidu.com",
      "domain": "baidu.com",
      "allowed": true,
      "timestamp": 1698739200000,
      "timestamp_str": "2025-10-31 16:30:00"
    }
  ]
}
```

**发送到**: `POST /api/classroom/guardian-reports/`

---

## 🖥️ MetaSeekOJ 后端集成

### 1. 创建数据库表

**文件**: `OnlineJudge/classroom/guardian_integration.py` （已创建）

**数据表**：
- `classroom_guardian_reports` - 访问记录
- `classroom_guardian_alerts` - 实时警报

### 2. 创建API视图

**文件**: `OnlineJudge/classroom/guardian_views.py` （已创建）

**API端点**：
- `POST /api/classroom/guardian-reports/` - 接收访问记录
- `POST /api/classroom/guardian-alert/` - 接收实时警报
- `GET /api/classroom/sessions/{id}/guardian-report/` - 查看报告
- `GET /api/classroom/sessions/{id}/guardian-alerts/` - 查看警报

### 3. 配置路由

在 `OnlineJudge/classroom/urls.py` 添加：

```python
from django.urls import path, include

urlpatterns = [
    # 现有路由
    path('courses/', ...),
    path('sessions/', ...),
    
    # Guardian集成
    path('', include('classroom.guardian_urls')),
]
```

### 4. 注册模型到admin

在 `OnlineJudge/classroom/admin.py` 添加：

```python
from .guardian_integration import GuardianAccessReport, GuardianAlert

@admin.register(GuardianAccessReport)
class GuardianAccessReportAdmin(admin.ModelAdmin):
    list_display = ['student', 'domain', 'allowed', 'timestamp']
    list_filter = ['allowed', 'timestamp']
    search_fields = ['domain', 'student__real_name']

@admin.register(GuardianAlert)
class GuardianAlertAdmin(admin.ModelAdmin):
    list_display = ['student', 'alert_type', 'domain', 'is_read', 'timestamp']
    list_filter = ['alert_type', 'is_read', 'timestamp']
    search_fields = ['domain', 'student__real_name']
```

---

## 🎯 完整测试流程

### 1. 后端部署

```bash
cd /home/sharelgx/MetaSeekOJdev/OnlineJudge
source django_env/bin/activate

# 迁移数据库
python manage.py makemigrations classroom
python manage.py migrate

# 重启服务
supervisorctl restart metaseekoj
```

### 2. 前端集成

在 `OnlineJudgeFE/src/pages/classroom/student/views/Learning.vue` 的 `mounted()` 中添加：

```javascript
mounted() {
  this.enableGuardian();
},

methods: {
  async enableGuardian() {
    const extensionId = 'pdpjidcjmkolcdaiolapcomjnbhgjekf';
    
    try {
      // 绑定学生
      await chrome.runtime.sendMessage(extensionId, {
        action: 'bindUser',
        data: {
          userId: this.$store.getters.user.id,
          username: this.$store.getters.user.real_name
        }
      });
      
      // 启用课堂模式
      await chrome.runtime.sendMessage(extensionId, {
        action: 'enableClassroomMode',
        data: {
          sessionId: this.$route.params.id,
          serverUrl: window.location.origin,
          allowedDomains: ['metaseekoj.com', 'localhost', 'baidu.com']
        }
      });
      
      this.$message.success('课堂保护已启用');
    } catch (error) {
      console.error('Guardian启用失败:', error);
    }
  }
}
```

### 3. 测试

```bash
1. 学生登录 MetaSeekOJ
2. 加入课堂 → Guardian自动启用
3. 学生访问 bilibili.com → 被拦截
4. 后端接收到警报
5. 教师端显示通知
```

---

## 📞 使用说明

### 学生端（自动）

加入课堂时自动：
1. 绑定学生信息
2. 启用Guardian保护
3. 开始上报访问记录

### 教师端（查看数据）

**方式1：查看实时警报**
```javascript
// 每5秒轮询
setInterval(async () => {
  const { data } = await axios.get(
    `/api/classroom/sessions/${sessionId}/guardian-alerts/`,
    { params: { unread_only: true } }
  );
  
  if (data.unread > 0) {
    // 显示通知
    showNotification(`有 ${data.unread} 条新警报`);
  }
}, 5000);
```

**方式2：查看完整报告**
```javascript
const { data } = await axios.get(
  `/api/classroom/sessions/${sessionId}/guardian-report/`
);

// data.students - 每个学生的统计
// data.top_blocked_domains - 最常违规的网站
```

---

## 🎉 完成！

Guardian 课堂集成已全部完成！

**功能**：
- ✅ 学生切换网站 → 实时上报
- ✅ 包含时间、网址、学生姓名
- ✅ 违规立即警报
- ✅ 课后查看报告

**测试**：刷新Guardian插件后，运行启用课堂模式的代码即可！

---

**需要后端部署帮助随时告诉我！** 😊

