# 🎓 Guardian 课堂接口 - 完成总结

**完成时间**: 2025-10-31  
**状态**: ✅ 接口已实现

---

## ✅ 您要求的功能已全部实现

### 需求：学生上课切换到其他网站就发送信息

**已实现**：
- ✅ 检测学生访问任何网站
- ✅ 实时发送到MetaSeekOJ后端
- ✅ 包含：时间、网址、学生姓名、是否被拦截

---

## 📡 工作流程

```
学生上课 → 访问网站
    ↓
Guardian检测（插件）
    ↓
① 允许访问 → 记录 → 5秒后批量上报
② 拦截访问 → 记录 → 立即警报
    ↓
发送到MetaSeekOJ
    ↓
POST /api/classroom/guardian-alert/     (立即)
POST /api/classroom/guardian-reports/   (批量)
    ↓
Django后端保存
    ↓
教师端查看
    ↓
实时通知 + 课后报告
```

---

## 📊 上报数据示例

### 数据1：学生访问违规网站（立即发送）

```json
{
  "type": "blocked_access",
  "session_id": 123,
  "student_id": "S001",
  "student_name": "张三",
  "domain": "bilibili.com",
  "url": "https://www.bilibili.com/video/xxx",
  "timestamp": 1698739200000,
  "message": "学生 张三 尝试访问被拦截的网站: bilibili.com"
}
```

**包含信息**：
- ✅ 学生姓名：张三
- ✅ 网址：bilibili.com
- ✅ 时间：2025-10-31 16:30:00
- ✅ 是否拦截：是

### 数据2：学生正常访问（批量发送）

```json
{
  "reports": [
    {
      "session_id": 123,
      "student_id": "S001",
      "student_name": "张三",
      "url": "https://www.baidu.com/s?wd=python",
      "domain": "baidu.com",
      "allowed": true,
      "reason": "",
      "timestamp": 1698739200000,
      "timestamp_str": "2025-10-31 16:30:00"
    }
  ]
}
```

---

## 🔧 集成步骤

### 步骤1：刷新Guardian插件

```bash
# 插件已更新代码，需要刷新
chrome://extensions/ → Guardian → 点刷新 🔄
```

### 步骤2：部署后端API

```bash
cd /home/sharelgx/MetaSeekOJdev/OnlineJudge
source django_env/bin/activate

# 数据库迁移
python manage.py makemigrations classroom
python manage.py migrate

# 配置路由（在 classroom/urls.py）
# 添加：path('', include('classroom.guardian_urls')),

# 重启服务
supervisorctl restart metaseekoj
```

### 步骤3：前端启用课堂模式

在学生加入课堂页面添加代码（自动执行）：

```javascript
// Learning.vue
mounted() {
  this.enableGuardianClassroomMode();
},

methods: {
  async enableGuardianClassroomMode() {
    const extensionId = 'pdpjidcjmkolcdaiolapcomjnbhgjekf';
    
    try {
      // 1. 绑定学生
      await chrome.runtime.sendMessage(extensionId, {
        action: 'bindUser',
        data: {
          userId: this.$store.getters.user.id,
          username: this.$store.getters.user.real_name
        }
      });
      
      // 2. 启用课堂模式
      await chrome.runtime.sendMessage(extensionId, {
        action: 'enableClassroomMode',
        data: {
          sessionId: this.$route.params.id,
          serverUrl: window.location.origin,
          allowedDomains: [
            'metaseekoj.com',
            'localhost',
            'baidu.com',
            'python.org'
          ]
        }
      });
      
      this.$message.success('课堂保护已启用');
    } catch (error) {
      console.error('启用失败:', error);
    }
  }
}
```

### 步骤4：教师端查看警报

```javascript
// Teaching.vue
data() {
  return {
    guardianAlerts: []
  }
},

mounted() {
  this.startMonitoring();
},

methods: {
  startMonitoring() {
    setInterval(async () => {
      const { data } = await this.$http.get(
        `/api/classroom/sessions/${this.sessionId}/guardian-alerts/`,
        { params: { unread_only: true } }
      );
      
      if (data.unread > 0) {
        this.$notify({
          title: '⚠️ 学生访问违规网站',
          message: `${data.alerts[0].student_name} 访问了 ${data.alerts[0].domain}`,
          type: 'warning'
        });
      }
    }, 5000);
  }
}
```

---

## 🎯 测试示例

### 手动测试（开发时）

**在Guardian的Service Worker控制台运行：**

```javascript
// 1. 启用课堂模式
chrome.runtime.sendMessage({
  action: 'enableClassroomMode',
  data: {
    sessionId: 1,
    serverUrl: 'http://localhost:8086',
    allowedDomains: ['localhost', 'baidu.com']
  }
}, (r) => console.log(r));

// 2. 绑定学生
chrome.runtime.sendMessage({
  action: 'bindUser',
  data: {
    userId: 'test001',
    username: '测试学生'
  }
}, (r) => console.log(r));

// 3. 访问B站测试
// 打开新标签页访问 www.bilibili.com
// 控制台应该显示：
// 🚨 违规警报已发送
```

---

## 📁 文件清单

### Guardian插件（已更新）
```
extension/background.js
- 新增：课堂模式配置
- 新增：reportToClassroom() 上报函数
- 新增：sendClassroomReport() 发送数据
- 新增：sendClassroomAlert() 发送警报
- 新增：enableClassroomMode 消息处理
```

### MetaSeekOJ后端（新增）
```
OnlineJudge/classroom/
├── guardian_integration.py  # 数据模型
├── guardian_views.py        # API视图
└── guardian_urls.py         # URL配置
```

### 文档
```
.trae/documents/
└── Guardian课堂集成接口文档.md  # 完整接口文档

guardian-browser-extension/
└── 课堂集成使用指南.md          # 使用指南
```

---

## 🎉 总结

**Guardian 课堂集成接口已完成！**

✅ **实时上报** - 学生访问任何网站都会上报  
✅ **违规警报** - 访问违规网站立即通知教师  
✅ **详细信息** - 时间、网址、学生姓名全部包含  
✅ **数据统计** - 课后生成完整报告  

**接下来**：
1. 刷新Guardian插件
2. 部署MetaSeekOJ后端API
3. 在课堂页面集成代码
4. 测试完整流程

**有任何问题随时问我！** 😊

