# 🎯 Guardian 使用说明 - 修复版

**问题已修复：** 
- ✅ 修复了按钮点击无效的问题
- ✅ 添加了详细的错误提示
- ✅ 添加了违规操作记录功能

---

## 🔄 重新安装插件（必须！）

由于修改了代码，需要重新加载插件：

### 步骤1：刷新插件

1. 打开 `chrome://extensions/`
2. 找到 **Guardian - 浏览器保护助手**
3. 点击「🔄」（刷新图标）
4. 或者点击「移除」后重新加载

### 步骤2：验证安装

确认：
- ✅ 插件状态：已启用
- ✅ 没有错误提示
- ✅ 版本：1.0.0

---

## 🎯 正确的使用步骤

### 测试拦截功能（完整步骤）

**① 打开B站**
```
在浏览器打开：www.bilibili.com
（应该能正常访问）
```

**② 点击插件图标**
```
点击浏览器工具栏的 Guardian 图标
（如果看不到，点击拼图图标找它）
```

**③ 先启用保护**
```
在弹窗中：
1. 把「启用保护」开关拖到右边（变绿色）
2. 看到右上角状态变成「已启用」（绿点）
```

**④ 加入黑名单**
```
1. 确认显示：www.bilibili.com
2. 点击「🚫 加入黑名单」按钮
3. 等待2秒
4. 应该看到绿色提示「✅ 已加入黑名单」
```

**⑤ 刷新页面测试**
```
1. 关闭弹窗
2. 按 F5 刷新 B站页面
3. 应该看到紫色渐变的拦截页面！
```

---

## 🐛 调试方法（如果按钮还是不好用）

### 方法1：打开控制台看日志

**① 打开插件的Service Worker控制台**
```
1. 打开 chrome://extensions/
2. 找到 Guardian
3. 点击「Service Worker」（蓝色链接）
4. 会打开开发者工具
```

**② 打开弹窗控制台**
```
1. 右键点击 Guardian 图标
2. 选择「检查弹出内容」
3. 会打开弹窗的开发者工具
```

**③ 点击按钮，观察控制台**
```
点击「加入黑名单」时，控制台应该显示：
- "点击加入黑名单，当前域名: bilibili.com"
- "后台响应: {success: true}"
- "[Toast] ✅ 已加入黑名单"

如果有红色错误，告诉我错误内容！
```

### 方法2：手动测试（绕过按钮）

**在Service Worker控制台中直接运行：**

```javascript
// 查看当前配置
chrome.storage.local.get('guardian_config', (data) => {
  console.log('当前配置:', data);
});

// 手动添加黑名单并启用
chrome.storage.local.set({
  guardian_config: {
    enabled: true,
    mode: 'blacklist',
    blacklist: ['bilibili.com', 'www.bilibili.com'],
    whitelist: [],
    timeControl: { enabled: false, schedules: [] },
    dailyLimit: { 
      enabled: false, 
      maxMinutes: 120, 
      usedMinutes: 0,
      lastResetDate: new Date().toISOString().split('T')[0]
    },
    tempPass: { active: false, domain: null, expiresAt: null },
    stats: { 
      todayBlocked: 0, 
      totalBlocked: 0, 
      todayAllowed: 0,
      lastResetDate: new Date().toISOString().split('T')[0]
    },
    violationLogs: [],
    userInfo: { userId: null, username: null, bindTime: null },
    password: null,
    firstInstall: false
  }
}, () => {
  console.log('✅ 配置已手动设置');
  alert('黑名单已添加！刷新B站页面试试');
});
```

**然后刷新B站页面（F5），应该被拦截！**

---

## 📋 违规操作记录功能说明

我已经添加了违规监控功能，会自动记录：

### 自动记录的操作

| 操作类型 | 触发时机 | 严重程度 |
|---------|---------|---------|
| **protection_disabled** | 用户关闭保护开关 | 🔴 高危 |
| **plugin_disabled** | 在扩展管理页面禁用插件 | 🔴 高危 |
| **plugin_uninstalled** | 卸载插件 | 🔴 高危 |
| **plugin_suspending** | 插件即将停止（卸载前） | 🔴 高危 |
| **temp_pass_granted** | 申请临时通行证 | 🟡 警告 |

### 记录的信息

每条违规记录包含：
- 👤 **用户信息**：用户ID、用户名
- 🔍 **操作类型**：具体做了什么
- 📝 **描述**：详细说明
- ⏰ **时间**：精确到秒

### 查看违规记录

**方式1：管理后台**
```
1. 打开 http://localhost:8888
2. 左侧点击「⚠️ 违规记录」
3. 查看所有记录
4. 可导出CSV文件
```

**方式2：控制台查看**
```javascript
// 在Service Worker控制台运行
chrome.storage.local.get('violationLogs', (data) => {
  console.table(data.violationLogs);
});
```

---

## 🎯 绑定用户信息（重要！）

为了记录"是谁"操作的，需要先绑定用户：

### 方式1：在插件中绑定

**在Service Worker控制台运行：**

```javascript
chrome.runtime.sendMessage({
  action: 'bindUser',
  data: {
    userId: '学号或ID',
    username: '学生姓名'
  }
}, (response) => {
  console.log('绑定结果:', response);
  alert('用户绑定成功！');
});
```

### 方式2：集成到MetaSeekOJ

在课堂页面自动绑定：

```javascript
// OnlineJudgeFE 课堂页面
window.dispatchEvent(new CustomEvent('guardian-bind-user', {
  detail: {
    userId: this.$store.getters.user.id,
    username: this.$store.getters.user.real_name
  }
}));
```

---

## ✅ 完整测试流程

### 测试1：基本拦截

```bash
# 1. 刷新插件
chrome://extensions/ → 找到Guardian → 点击刷新图标

# 2. 在Service Worker控制台手动配置
chrome.storage.local.set({
  guardian_config: {
    enabled: true,
    mode: 'blacklist',
    blacklist: ['bilibili.com'],
    whitelist: [],
    stats: { todayBlocked: 0, totalBlocked: 0, todayAllowed: 0 }
  }
});

# 3. 访问B站
www.bilibili.com → 应该被拦截

# 4. 检查统计
点击插件图标 → 今日拦截应该显示 1
```

### 测试2：违规记录

```bash
# 1. 点击插件图标，关闭保护开关
→ 违规记录：protection_disabled

# 2. chrome://extensions/ 禁用Guardian
→ 违规记录：plugin_disabled

# 3. 查看记录
管理后台 → 违规记录 → 看到2条记录
```

---

## 📞 如果按钮还是不好用

请告诉我：

1. **控制台有什么错误？**
   - 打开弹窗控制台（右键插件图标→检查弹出内容）
   - 点击按钮
   - 复制红色错误信息

2. **点击后有什么反应？**
   - 完全没反应？
   - 还是有错误提示？

3. **当前域名显示什么？**
   - 在弹窗中能看到 bilibili.com 吗？

我会根据您的反馈继续修复！

---

**立即尝试：刷新插件后重新测试** 🔄

